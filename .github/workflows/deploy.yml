name: üöÄ Deploy SSG

on:
  push:
    branches: [main]
    paths:
      - 'data/**'
      - 'public/admin/**'
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ‚úÖ –ü—Ä–æ—Å—Ç–æ —Å—Ç–∞–≤–∏–º Node.js, –±–µ–∑ –∫—ç—à–∞ pnpm
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ‚úÖ –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º pnpm
      - name: üì¶ Install pnpm globally
        run: npm install -g pnpm@9

      # ‚úÖ –û—Ç–¥–µ–ª—å–Ω–æ –∫—ç—à–∏—Ä—É–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ pnpm
      - name: üì¶ Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      # ‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      - name: üì¶ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: üî® Generate static site
        run: pnpm run generate
        env:
          NUXT_PUBLIC_SITE_URL: ${{ secrets.NUXT_PUBLIC_SITE_URL }}

      - name: üì§ Deploy to Yandex Object Storage
        uses: shallwefootball/s3-upload-action@master
        with:
          aws_key_id: ${{ secrets.YC_ACCESS_KEY }}
          aws_secret_access_key: ${{ secrets.YC_SECRET_KEY }}
          aws_bucket: ${{ secrets.YC_BUCKET_NAME }}
          aws_region: ru-central1
          source_dir: '.output/public'
          destination_dir: '/'
          delete_removed_files: true

      - name: ‚úÖ Deploy complete
        run: echo "–°–∞–π—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!"